<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<section class="rvp-main page-width">
  {% if section.settings.title != blank %}
    <h1 class="section-title">{{ section.settings.title }}</h1>
  {% endif %}

  {% if section.settings.sub_title != blank %}
    <div class="sub-title">{{ section.settings.sub_title }}</div>
  {% endif %}

  <div class="swiper-container rv-products">
    <div class="swiper-wrapper">
      {% for product in section.settings.rv_products %}
        <div class="swiper-slide">
          <div class="rv-products-box">
            <img src="{{ product.images.first | image_url }}" alt="{{ product.title }}">
            <div class="rv-products-box-info">
              <h3>{{ product.title }}</h3>
              <div class="product-description">{{ product.description }}</div>
              <div class="rv-main-price">$ {{ product.price }}</div>
              <button>Add to cart</button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Progress bar (scrollbar) -->
    <div class="swiper-scrollbar"></div>
  </div>

  <div id="recently-viewed-products">
  <h3>Recently Viewed</h3>
  <div id="recently-viewed-container"></div>
</div>

</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    new Swiper(".swiper-container", {
      slidesPerView: 1,
      spaceBetween: 10,
      loop: false,
      scrollbar: {
        el: ".swiper-scrollbar",
        draggable: true,
      },
      breakpoints: {
        640: {
          slidesPerView: {{ section.settings.mobile_count }},
        },
        1024: {
          slidesPerView: {{ section.settings.iPad_count }},
        },
        1366: {
          slidesPerView: {{ section.settings.desktop_count }},
        },
      },
    });
  });



      document.addEventListener('DOMContentLoaded', function () {
    const maxItems = 5;
    const currentHandle = '{{ product.handle }}';
    const productTitle = '{{ product.title }}';
    const productImage = '{{ product.featured_image | img_url: "medium" }}';
    const productUrl = '{{ product.url }}';

    let viewed = JSON.parse(localStorage.getItem('recently_viewed')) || [];

    // Remove if already in list
    viewed = viewed.filter(p => p.handle !== currentHandle);

    // Add current product
    viewed.unshift({
      handle: currentHandle,
      title: productTitle,
      image: productImage,
      url: productUrl
    });

    // Limit to max items
    viewed = viewed.slice(0, maxItems);

    // Save back to localStorage
    localStorage.setItem('recently_viewed', JSON.stringify(viewed));

    // Render
    const container = document.getElementById('recently-viewed-container');
    if (container) {
      viewed.forEach(product => {
        if (product.handle !== currentHandle) {
          const html = `
            <div class="recent-item">
              <a href="${product.url}">
                <img src="${product.image}" alt="${product.title}" style="max-width: 100px;" />
                <p>${product.title}</p>
              </a>
            </div>
          `;
          container.insertAdjacentHTML('beforeend', html);
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "Recently Viewed Products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title"
    },
     {
      "type": "text",
      "id": "sub_title",
      "label": "Section Sub Title"
    },
    {
      "type": "header",
      "content": "Recently Viewed"
    },
    {
      "type": "product_list",
      "id": "rv_products",
      "label": "Recently Products"
    },
    {
      "type": "text",
      "id": "desktop_count",
      "label": "Products on Desktop"
    },
    {
      "type": "text",
      "id": "iPad_count",
      "label": "Products on iPad"
    },
    {
      "type": "text",
      "id": "mobile_count",
      "label": "Products on Mobile"
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed Products"
    }
  ]
}
{% endschema %}
