<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<section class="rvp-main page-width">
  {% if section.settings.title != blank %}
    <h1 class="section-title">{{ section.settings.title }}</h1>
  {% endif %}

  {% if section.settings.sub_title != blank %}
    <div class="sub-title">{{ section.settings.sub_title }}</div>
  {% endif %}

  <div class="swiper-container rv-products">
    <div class="swiper-wrapper">
      {% for product in section.settings.rv_products %}
        <div class="swiper-slide">
          <div class="rv-products-box">
            <img src="{{ product.images.first | image_url }}" alt="{{ product.title }}">
            <div class="rv-products-box-info">
             <a href="{{  product.url }}"> <h3>{{ product.title }}</h3> </a>
              <div class="product-description">{{ product.description }}</div>
              <div class="rv-main-price">$ {{ product.price }}</div>
              <button>Add to cart</button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Progress bar (scrollbar) -->
    <div class="swiper-scrollbar"></div>
  </div>

<div class="swiper-container rv-products" id="recently-viewed-products">
  <div class="swiper-wrapper" id="recently-viewed-wrapper">
    <!-- Recently viewed products will be injected here via JavaScript -->
  </div>

  <!-- Progress bar (scrollbar) -->
  <div class="swiper-scrollbar"></div>
</div>


</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    new Swiper(".swiper-container", {
      slidesPerView: 1,
      spaceBetween: 10,
      loop: false,
      scrollbar: {
        el: ".swiper-scrollbar",
        draggable: true,
      },
      breakpoints: {
        640: {
          slidesPerView: {{ section.settings.mobile_count }},
        },
        1024: {
          slidesPerView: {{ section.settings.iPad_count }},
        },
        1366: {
          slidesPerView: {{ section.settings.desktop_count }},
        },
      },
    });
  });



      document.addEventListener('DOMContentLoaded', function () {
    const maxItems = 5;
    const currentHandle = '{{ product.handle }}';
    const productData = {
      handle: currentHandle,
      title: '{{ product.title | escape }}',
      image: '{{ product.image | image_url: "medium" }}',
      description: `{{ product.description | strip_html | truncate: 100 | escape }}`,
      price: '{{ product.price | money_without_currency }}',
      url: '{{ product.url }}'
    };



        console.log(productData);


        return false;

    let viewed = JSON.parse(localStorage.getItem('recently_viewed')) || [];

    // Remove current if it exists
    viewed = viewed.filter(p => p.handle !== currentHandle);

    // Add current to beginning
    viewed.unshift(productData);

    // Limit number of items
    viewed = viewed.slice(0, maxItems);

    // Store updated list
    localStorage.setItem('recently_viewed', JSON.stringify(viewed));

    // Render
    const wrapper = document.getElementById('recently-viewed-wrapper');
    if (wrapper) {
      viewed.forEach(product => {
        if (product.handle !== currentHandle) {
          const slide = `
            <div class="swiper-slide">
              <div class="rv-products-box">
                <a href="${product.url}">
                  <img src="${product.image}" alt="${product.title}">
                </a>
                <div class="rv-products-box-info">
                  <h3>${product.title}</h3>
                  <div class="product-description">${product.description}</div>
                  <div class="rv-main-price">$ ${product.price}</div>
                  <button onclick="window.location.href='${product.url}'">View Product</button>
                </div>
              </div>
            </div>
          `;
          wrapper.insertAdjacentHTML('beforeend', slide);
        }
      });

      // Initialize Swiper (if not already initialized)
      new Swiper('.swiper-container.rv-products', {
        slidesPerView: 2,
        spaceBetween: 20,
        scrollbar: {
          el: '.swiper-scrollbar',
          hide: false,
        },
        breakpoints: {
          768: { slidesPerView: 3 },
          1024: { slidesPerView: 4 },
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "Recently Viewed Products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title"
    },
     {
      "type": "text",
      "id": "sub_title",
      "label": "Section Sub Title"
    },
    {
      "type": "header",
      "content": "Recently Viewed"
    },
    {
      "type": "product_list",
      "id": "rv_products",
      "label": "Recently Products"
    },
    {
      "type": "text",
      "id": "desktop_count",
      "label": "Products on Desktop"
    },
    {
      "type": "text",
      "id": "iPad_count",
      "label": "Products on iPad"
    },
    {
      "type": "text",
      "id": "mobile_count",
      "label": "Products on Mobile"
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed Products"
    }
  ]
}
{% endschema %}
